#!/bin/bash

set -ex

# get version from env or use default
NPS_VERSION=${NPS_VERSION:-1.11.33.2}

echo "Building ngx_pagespeed ${NPS_VERSION}"

UBUNTU_VERSION=`lsb_release -c | cut -f2`

# quote the / since it will go into sed
PS_NGX_EXTRA_FLAGS="--with-cc=\/usr\/lib\/gcc-mozilla\/bin\/gcc  --with-ld-opt=-static-libstdc++"

sudo apt-get install build-essential -y
sudo apt-get install dpkg-dev build-essential zlib1g-dev libpcre3 libpcre3-dev unzip gcc-mozilla checkinstall -y


# build dir
get_abs_filename() {
  # $1 : relative filename
  echo "$(cd "$(dirname "$1")" && pwd)/$(basename "$1")"
}
NGX_BUILD=$(get_abs_filename "./ngx_build")
rm -rf $NGX_BUILD
mkdir $NGX_BUILD
cd $NGX_BUILD

wget http://nginx.org/download/nginx-1.11.1.tar.gz
tar zxf nginx-1.11.1.tar.gz

wget https://www.openssl.org/source/openssl-1.0.2h.tar.gz
tar zxf openssl-1.0.2h.tar.gz

# steps from https://github.com/pagespeed/ngx_pagespeed
# download pagespeed
wget https://github.com/pagespeed/ngx_pagespeed/archive/release-${NPS_VERSION}-beta.zip
unzip release-${NPS_VERSION}-beta.zip
cd ngx_pagespeed-release-${NPS_VERSION}-beta/
wget https://dl.google.com/dl/page-speed/psol/${NPS_VERSION}.tar.gz
tar -xzvf ${NPS_VERSION}.tar.gz  # extracts to psol/
cd ..

cd nginx-1.11.1
./configure \
	--user=nginx \
	--group=nginx \
	 --prefix=/etc/nginx \
--sbin-path=/usr/sbin/nginx \
--conf-path=/etc/nginx/nginx.conf \
--error-log-path=/var/log/nginx/error.log \
--http-log-path=/var/log/nginx/access.log \
--pid-path=/var/run/nginx.pid \
--lock-path=/var/run/nginx.lock \
--http-client-body-temp-path=/var/cache/nginx/client_temp \
--http-proxy-temp-path=/var/cache/nginx/proxy_temp \
--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \
--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \
--http-scgi-temp-path=/var/cache/nginx/scgi_temp \
--with-cc-opt='-g -O2 -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2' \
--with-ld-opt='-Wl,-z,relro -Wl,--as-needed' \
	--add-module=../ngx_pagespeed-release-${NPS_VERSION}-beta \
	${PS_NGX_EXTRA_FLAGS} \
	--with-openssl=../openssl-1.0.2h \
	 --with-http_ssl_module \
	--with-http_v2_module \
	--with-http_stub_status_module \
	--with-http_realip_module

make

sudo checkinstall -D --install=no -y make install
sudo rm -rf doc-pak
mv *.deb $NGX_BUILD/
