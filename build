#!/bin/bash -x 

set -x

# get version from env or use default
NPS_VERSION=${NPS_VERSION:-1.10.33.1}

echo "Building ngx_pagespeed ${NPS_VERSION}"

UBUNTU_VERSION=`lsb_release -c | cut -f2`

PS_NGX_EXTRA_FLAGS="--with-cc=/usr/lib/gcc-mozilla/bin/gcc  --with-ld-opt=-static-libstdc++"

sudo apt-get install build-essential -y
sudo apt-get build-dep nginx -y
sudo apt-get install dpkg-dev build-essential zlib1g-dev libpcre3 libpcre3-dev git unzip libssl-dev devscripts gcc-mozilla -y

wget -N http://nginx.org/keys/nginx_signing.key
sudo apt-key add nginx_signing.key
rm nginx_signing.key

# add nginx to sources
echo "deb http://nginx.org/packages/ubuntu/ ${UBUNTU_VERSION} nginx" | sudo tee /etc/apt/sources.list.d/nginx.list
echo "deb-src http://nginx.org/packages/ubuntu/ ${UBUNTU_VERSION} nginx" | sudo tee -a /etc/apt/sources.list.d/nginx.list

# update list of packages
sudo apt-get update

# build dir
get_abs_filename() {
  # $1 : relative filename
  echo "$(cd "$(dirname "$1")" && pwd)/$(basename "$1")"
}
NGX_BUILD=$(get_abs_filename "./ngx_build")
rm -rf $NGX_BUILD
mkdir $NGX_BUILD
cd $NGX_BUILD

# install any packages needed for nginx
sudo apt-get build-dep nginx -y

apt-get source nginx
NGINX_VER=$(find ./nginx* -maxdepth 0 -type d | sed "s|^\./||")
NGINX_BUILD_DIR=$NGX_BUILD/$NGINX_VER

echo "Using nginx ${NGINX_VER}"

# can edit debian/rules for your modules
# here we use sed to add the geoip module
#sed -i '/--with-http_sub_module \\/i--with-http_geoip_module \\' $NGINX_BUILD_DIR/debian/rules

# create a modules dir to hold the pagespeed module
mkdir $NGINX_BUILD_DIR/modules
cd $NGINX_BUILD_DIR/modules

# steps from https://github.com/pagespeed/ngx_pagespeed
# download pagespeed
wget https://github.com/pagespeed/ngx_pagespeed/archive/release-${NPS_VERSION}-beta.zip
unzip release-${NPS_VERSION}-beta.zip
cd ngx_pagespeed-release-${NPS_VERSION}-beta/
wget https://dl.google.com/dl/page-speed/psol/${NPS_VERSION}.tar.gz
tar -xzvf ${NPS_VERSION}.tar.gz  # extracts to psol/

# now enable pagespeed module in debian/rules
sed -i "s/\.\/configure /.\/configure --add-module=modules\/ngx_pagespeed-release-${NPS_VERSION}-beta /g" $NGINX_BUILD_DIR/debian/rules

# lets add our version number
cd $NGINX_BUILD_DIR
dch -p -v ${NGINX_VER:6}+nps${NPS_VERSION} "Adding ngx_pagespeed ${NPS_VERSION}"

# build deb
dpkg-buildpackage -b

# debs should be in ngx_build

